<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur Vidéo Combiné</title>

    <!-- CSS Imports -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/player-crimson.css">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800&display=swap" rel="stylesheet">
</head>
<body>

    <video id="player" playsinline controls preload="metadata" poster="https://xalaflix.eu/upload/images/bmFSbK6HMDz5moHjIkf3BatBdca.jpg">
        <source id="video-source" src="https://mayi22140.mayicloud.com/files/aa/bU4cGZhssurEmByhmkSHnXVytre4pqbAkgM.m3u8" type="application/x-mpegURL">
        <track kind="subtitles" label="Français" srclang="fr" src="sous-titres/subtitles.vtt" default>
        Votre navigateur ne prend pas en charge la balise vidéo.
    </video>

    <!-- JS Imports -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const playerControls = ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen', 'settings', 'download'];

            const player = new Plyr('#player', {
                controls: playerControls,
                quality: {
                    default: 720,
                    options: [720]
                },
                playsinline: true,
                keyboard: { focused: true, global: true },
                fullscreen: { enabled: true, fallback: true, iosNative: true },
                disableContextMenu: true,
                i18n: {
                    play: 'Play',
                    pause: 'Pause',
                    mute: 'Silence',
                    unmute: 'Son activé',
                    enableCaptions: 'Activer les sous-titres',
                    disableCaptions: 'Désactiver les sous-titres',
                    download: 'Télécharger',
                    enterFullscreen: 'Plein écran',
                    exitFullscreen: 'Sortir du plein écran',
                    settings: 'Réglages',
                    speed: 'Vitesse',
                    quality: 'Qualité',
                    loop: 'Boucle',
                    disabled: 'Désactivé',
                    enabled: 'Activé',
                    captions: 'Sous-titres',
                },
            });

            const videoElement = document.getElementById('player');
            const videoSource = document.getElementById('video-source');
            const storageKey = generateStorageKey(videoSource.src);

            // Fonction pour générer une clé unique basée sur l'URL de la vidéo
            const generateStorageKey = (url) => `videoPlayerPosition_${url}`;

            // Sauvegarder la position de lecture
            const savePosition = () => {
                const currentTime = videoElement.currentTime;
                localStorage.setItem(storageKey, currentTime);
                console.log(`Position de lecture sauvegardée : ${currentTime} secondes pour la vidéo ${videoSource.src}.`);
            };

            // Sauvegarder la position quand la vidéo est mise en pause
            videoElement.addEventListener('pause', savePosition);

            // Sauvegarder la position lorsque l'utilisateur quitte la page
            window.addEventListener('beforeunload', savePosition);

            // Supprimer la position si la vidéo est terminée
            videoElement.addEventListener('ended', () => {
                localStorage.removeItem(storageKey);
                console.log('Lecture terminée, position supprimée pour la vidéo ' + videoSource.src);
            });

            // Récupérer la position de lecture enregistrée pour cette vidéo
            const savedPosition = localStorage.getItem(storageKey);
            if (savedPosition) {
                videoElement.currentTime = parseFloat(savedPosition);
                console.log(`Reprise de la lecture à la position : ${savedPosition} secondes pour la vidéo ${videoSource.src}.`);
            }

            // HLS (HTTP Live Streaming) support
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(videoSource.src);
                hls.attachMedia(videoElement);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    videoElement.play();
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = videoSource.src;
                videoElement.addEventListener('loadedmetadata', function() {
                    videoElement.play();
                });
            }
        });
    </script>
</body>
</html>

